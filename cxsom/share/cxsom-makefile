cxsom-help:
	@echo
	@echo "##################"
	@echo "#                #"
	@echo "# cxsom commands #"
	@echo "#                #"
	@echo "##################"
	@echo
	@echo "# at both sides"
	@echo
	@echo "  make cxsom-set-config ROOT_DIR=./root_dir HOSTNAME=localhost PORT=10000 SKEDNET_PORT=20000 NB_THREADS=4 VENV=cxsom-venv"
	@echo "  make cxsom-show-config"
	@echo
	@echo "  make cxsom-set-rootdir      ROOT_DIR=./root_dir"
	@echo "  make cxsom-set-hostname     HOSTNAME=localhost"
	@echo "  make cxsom-set-port         PORT=10000"
	@echo "  make skednet-set-port       SKEDNET_PORT=20000"
	@echo "  make cxsom-set-nbthreads    NB_THREADS=4"
	@echo "  make cxsom-set-venv         VENV=cxsom-venv"
	@echo
	@echo "  make cxsom-clear-rootdir"
	@echo
	@echo "  make cxsom-make-venv             // Creates (if needed) the venv"
	@echo "  make cxsom-install-venv          // Installs pycxsom and other stuff in venv"
	@echo "  make cxsom-show-venv-activation  // displays the venv activation command"
	@echo
	@echo "# at server side"
	@echo 
	@echo "  make skednet-launch-xrsw // starts a skednet data access locker at server side..."
	@echo "  make skednet-kill-xrsw   // ... kills it"
	@echo "  make skednet-is-xrsw-running"
	@echo
	@echo "  make cxsom-launch-processor           // Usual processor"
	@echo "  make cxsom-launch-monitored-processor // Enables monitoring (generates a monitoring.data file)."
	@echo "  make cxsom-launch-verbose-processor   // Very verbose, for developpers."
	@echo
	@echo "  // the following are the same as previously, but they use a skednet data access locker."
	@echo "  make skednet-launch-processor           // Usual processor"
	@echo "  make skednet-launch-monitored-processor // Enables monitoring (generates a monitoring.data file)."
	@echo "  make skednet-launch-verbose-processor   // Very verbose, for developpers."
	@echo
	@echo "  make cxsom-is-processor-running"
	@echo "  make cxsom-kill-processor"
	@echo
	@echo "# at client side"
	@echo
	@echo "  make cxsom-clear-processor"
	@echo "  make cxsom-ping-processor"
	@echo "  make cxsom-scan-vars"
	@echo 
	@echo "  make cxsom-monitoring-report  // If some monitoring.data file has been generated, this command"
	@echo "                                // parses it and generates a monitoring.md report. You can use "
	@echo "                                // the command 'grip monitoring.md' to render the report on a "
	@echo "                                // web page (the page will update each time you re-build the report)."
	@echo
	@echo

ROOTDIR_CONFIG_FILE      = .cxsom-rootdir-config
HOSTNAME_CONFIG_FILE     = .cxsom-hostname-config
PORT_CONFIG_FILE         = .cxsom-port-config
SKEDNET_PORT_CONFIG_FILE = .skednet-port-config
NBTHREADS_CONFIG_FILE    = .cxsom-nbthreads-config
VENV_CONFIG_FILE         = .cxsom-venv-config

.PHONY: cxsom-show-config
cxsom-show-config:
	@echo
	@echo "python virtual environment =" `cat $(VENV_CONFIG_FILE)`
	@echo "nb_threads                 =" `cat $(NBTHREADS_CONFIG_FILE)`
	@echo "server hostname            =" `cat $(HOSTNAME_CONFIG_FILE)`
	@echo "port                       =" `cat $(PORT_CONFIG_FILE)`
	@echo "skednet port               =" `cat $(SKEDNET_PORT_CONFIG_FILE)`
	@echo "variables rootdir          =" `cat $(ROOTDIR_CONFIG_FILE)`
	@echo


.PHONY: cxsom-set-rootdir
cxsom-set-rootdir:
	@rm -f $(ROOTDIR_CONFIG_FILE)
	@echo $(ROOT_DIR) > $(ROOTDIR_CONFIG_FILE)

.PHONY: cxsom-set-hostname
cxsom-set-hostname:
	@rm -f $(HOSTNAME_CONFIG_FILE)
	@echo $(HOSTNAME) > $(HOSTNAME_CONFIG_FILE)

.PHONY: cxsom-set-port
cxsom-set-port:
	@rm -f $(PORT_CONFIG_FILE)
	@echo $(PORT) > $(PORT_CONFIG_FILE)

.PHONY: skednet-set-port
skednet-set-port:
	@rm -f $(SKEDNET_PORT_CONFIG_FILE)
	@echo $(SKEDNET_PORT) > $(SKEDNET_PORT_CONFIG_FILE)

.PHONY: cxsom-set-nbthreads
cxsom-set-nbthreads:
	@rm -f $(NBTHREADS_CONFIG_FILE)
	@echo $(NB_THREADS) > $(NBTHREADS_CONFIG_FILE)

.PHONY: cxsom-set-venv
cxsom-set-venv:
	@rm -f $(VENV_CONFIG_FILE)
	@echo $(VENV) > $(VENV_CONFIG_FILE)

.PHONY: cxsom-set-config
cxsom-set-config: | cxsom-set-rootdir cxsom-set-hostname cxsom-set-port skednet-set-port cxsom-set-nbthreads cxsom-set-venv


.PHONY: cxsom-make-venv
cxsom-make-venv:
	python3 -m venv `cat $(VENV_CONFIG_FILE)`

.PHONY: cxsom-install-venv
cxsom-install-venv:
	. `cat $(VENV_CONFIG_FILE)`/bin/activate; pip install git+https://github.com/HerveFrezza-Buet/cxsom#subdirectory=pycxsom
	. `cat $(VENV_CONFIG_FILE)`/bin/activate; pip install pandoc

.PHONY: cxsom-show-venv-activation
cxsom-show-venv-activation:
	@echo
	@echo . `cat $(VENV_CONFIG_FILE)`/bin/activate

.PHONY: cxsom-clear-rootdir
cxsom-clear-rootdir:
	@cxsom-ask "Do you really want to clear `cat $(ROOTDIR_CONFIG_FILE)` ?" || rm -rf `cat $(ROOTDIR_CONFIG_FILE)`/*

.PHONY: skednet-launch-xrsw
skednet-launch-xrsw:
	@skednet-xrsw `cat $(SKEDNET_PORT_CONFIG_FILE)`&

.PHONY: skednet-kill-xrsw
skednet-kill-xrsw:
	@killall -q skednet-xrsw || echo 'No xrsw to kill'

.PHONY: skednet-is-xrsw-running
skednet-is-xrsw-running:
	@ps -aux | grep 'skednet-xrsw' | grep `cat $(SKEDNET_PORT_CONFIG_FILE)` | wc -l | cxsom-conditional-message "xrsw [RUNNING]" "xrsw [KILLED ]"; echo

.PHONY: cxsom-launch-processor
cxsom-launch-processor:
	@cxsom-processor `cat $(ROOTDIR_CONFIG_FILE)` `cat $(NBTHREADS_CONFIG_FILE)` `cat $(PORT_CONFIG_FILE)`&

.PHONY: cxsom-launch-verbose-processor
cxsom-launch-verbose-processor:
	@cxsom-verbose-processor `cat $(ROOTDIR_CONFIG_FILE)` `cat $(NBTHREADS_CONFIG_FILE)` `cat $(PORT_CONFIG_FILE)`&

.PHONY: cxsom-launch-monitored-processor
cxsom-launch-monitored-processor:
	@cxsom-monitored-processor `cat $(ROOTDIR_CONFIG_FILE)` `cat $(NBTHREADS_CONFIG_FILE)` `cat $(PORT_CONFIG_FILE)`&

.PHONY: skednet-launch-processor
skednet-launch-processor:
	@cxsom-processor `cat $(ROOTDIR_CONFIG_FILE)` `cat $(NBTHREADS_CONFIG_FILE)` `cat $(PORT_CONFIG_FILE)` localhost `cat $(SKEDNET_PORT_CONFIG_FILE)`&

.PHONY: skednet-launch-verbose-processor
skednet-launch-verbose-processor:
	@cxsom-verbose-processor `cat $(ROOTDIR_CONFIG_FILE)` `cat $(NBTHREADS_CONFIG_FILE)` `cat $(PORT_CONFIG_FILE)` localhost `cat $(SKEDNET_PORT_CONFIG_FILE)`&

.PHONY: skednet-launch-monitored-processor
skednet-launch-monitored-processor:
	@cxsom-monitored-processor `cat $(ROOTDIR_CONFIG_FILE)` `cat $(NBTHREADS_CONFIG_FILE)` `cat $(PORT_CONFIG_FILE)` localhost `cat $(SKEDNET_PORT_CONFIG_FILE)`&

.PHONY: cxsom-is-processor-running
cxsom-is-processor-running:
	@ps -aux | grep 'cxsom-processor' | grep `cat $(ROOTDIR_CONFIG_FILE)` | wc -l |           cxsom-conditional-message "          processor [RUNNING]" "          processor [       ]"; echo
	@ps -aux | grep 'cxsom-verbose-processor' | grep `cat $(ROOTDIR_CONFIG_FILE)` | wc -l |   cxsom-conditional-message "verbose   processor [RUNNING]" "verbose   processor [       ]"; echo
	@ps -aux | grep 'cxsom-monitored-processor' | grep `cat $(ROOTDIR_CONFIG_FILE)` | wc -l | cxsom-conditional-message "monitored processor [RUNNING]" "monitored processor [       ]"; echo

.PHONY: cxsom-kill-processor
cxsom-kill-processor:
	@killall -q cxsom-processor || echo 'No cxsom-processor to kill'
	@killall -q cxsom-verbose-processor || echo 'No cxsom-verbose-processor to kill'
	@killall -q cxsom-monitored-processor || echo 'No cxsom-monitored-processor to kill'
	@sleep 1
	@echo
	@echo 'cxsom processors should have been killed now : Is it running ?'
	@make --quiet cxsom-is-processor-running

.PHONY: cxsom-ping-processor
cxsom-ping-processor:
	@cxsom-ping `cat $(HOSTNAME_CONFIG_FILE)` `cat $(PORT_CONFIG_FILE)`

.PHONY: cxsom-clear-processor
cxsom-clear-processor:
	@cxsom-clear `cat $(HOSTNAME_CONFIG_FILE)` `cat $(PORT_CONFIG_FILE)`

.PHONY: cxsom-show-vars
cxsom-show-vars:
	@cxsom-all-instances `cat $(ROOTDIR_CONFIG_FILE)`

.PHONY: cxsom-scan-vars
cxsom-scan-vars:
	@gnome-terminal --title='scanning '`cat $(ROOTDIR_CONFIG_FILE)` --working-directory=$(PWD) -- /bin/bash -c 'while sleep 1; do clear; make --quiet cxsom-show-vars; done'

.PHONY: cxsom-monitoring-report
cxsom-monitoring-report:
	@cxsom-monitor-situation-report > monitoring.md
	@echo File monitoring.md is the generated report.
